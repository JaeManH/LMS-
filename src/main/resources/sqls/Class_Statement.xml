<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.min.daoImpl.Class">
<!-- ■■■ 과정 Statement ■■■ -->
<!-- 과정 전체 조회 -->
<select id="classSelectAll" resultType="ClassVo">
SELECT CLA_NUM , CLA_TITLE , CASE WHEN LENGTH(CLA_CONTENT) > 30 THEN SUBSTR(CLA_CONTENT,0,30) || '...' ELSE CLA_CONTENT END CLA_CONTENT, TO_CHAR(CLA_STARTDATE,'YYYY-MM-DD') AS CLA_STARTDATE,
	   CLA_DAILYTIME , CLA_TOTALTIME, CLA_MAXPEO , CLA_PRICE, JSON_QUERY(CLA_LIKE ,'$' RETURNING VARCHAR2) AS CLA_LIKE, CLA_STATUS
	FROM CLASS c
	ORDER BY CLA_NUM
</select>

<!-- 과정 카테고리 구분 조회 -->
<select id="classSelected" resultType="ClassVo">
SELECT SUBSTR(CLA_NUM,4)+0 AS CLA_NUM , CLA_TITLE , CASE WHEN LENGTH(CLA_CONTENT) > 30 THEN SUBSTR(CLA_CONTENT,0,30) || '...' ELSE CLA_CONTENT END CLA_CONTENT,CLA_STARTDATE,
	   CLA_DAILYTIME , CLA_TOTALTIME, CLA_MAXPEO , CLA_PRICE, JSON_QUERY(CLA_LIKE ,'$' RETURNING VARCHAR2) AS CLA_LIKE, CLA_STATUS
	FROM CLASS c
	WHERE CLA_STATUS = #{cla_status}
	ORDER BY CLA_NUM
</select>

<!-- 과정 상세 조회 -->
<select id="classSelectDetail" resultType="ClassVo" parameterType="ClassVo">
SELECT CLA_NUM, CLA_TITLE , CLA_CONTENT , CLA_MAXPEO , CLA_PRICE , CLA_DAILYTIME ,
	   CLA_STARTDATE , CLA_TOTALTIME ,  JSON_QUERY(CLA_LIKE ,'$' RETURNING VARCHAR2) AS CLA_LIKE, 
	   TO_CHAR(CLA_REGDATE,'YYYY-MM-DD') AS CLA_REGDATE, CLA_STATUS 
	FROM CLASS c 
	WHERE CLA_NUM = #{cla_num}
</select>

<select id="classSelectedSub" resultType="SubjectVo" parameterType="java.lang.String">
SELECT SUB_TITLE ,SUB_CONTENT
	FROM SUBJECT, CLASS_SUBJECT
	WHERE SUB_NUM = CSU_SUB_NUM AND CSU_CLA_NUM = #{csu_cla_num}
</select>

<!-- 과정 과목 리스트 선택 -->
<select id="classSelectedIns" resultType="java.util.List" parameterType="java.lang.String">
SELECT SUB_NUM ,SUB_INS ,CSU_CLA_NUM
	FROM SUBJECT ,CLASS_SUBJECT
	WHERE SUB_NUM = CSU_SUB_NUM AND CSU_CLA_NUM = #{csu_cla_num}
</select>

<!-- 과정 입력 폼 생성 -->
<insert id="classFormInsert" parameterType="java.util.Map">
INSERT INTO CLASS (CLA_NUM, CLA_TITLE, CLA_CONTENT, 
				   CLA_STATUS, CLA_REGDATE, CLA_ENDRECRUIT,
				   CLA_ENDVOTE)
			VALUES((SELECT 'CLA'||LPAD(MAX(SUBSTR(CLA_NUM,4)+1),3,'0') FROM CLASS), #{cla_title}, #{cla_content},
				   '모집중', TO_CHAR(SYSDATE,'YYYY-MM-dd'), TO_CHAR(SYSDATE+7,'YYYY-MM-dd'),
				   TO_CHAR(SYSDATE+10,'YYYY-MM-dd'))
</insert>

<!-- 과정 과목 리스트 생성 -->
<insert id="classSubjectInsert" parameterType="java.util.Map">
INSERT INTO CLASS_SUBJECT (CSU_SEQ, CSU_SUB_NUM, CSU_CLA_NUM)
	 			   VALUES (CLASS_SUBJECT_SEQ.NEXTVAL, #{csu_sub_num}, (SELECT MAX(CLA_NUM)FROM CLASS c))
</insert>

<!-- 과정 투표박스 생성 -->
<insert id="voteBoxInsert" parameterType="java.util.Map">
INSERT INTO VOTE (VOT_CLA_NUM, VOT_SUB_NUM)
		VALUES((SELECT MAX(CLA_NUM)FROM CLASS c), #{vot_sub_num})
</insert>
<select id="classTimeSearch" resultType="java.lang.Integer" parameterType="java.lang.String">
SELECT CEIL (CLA_TOTALTIME/CLA_DAILYTIME)
	FROM CLASS c 
	WHERE CLA_NUM =#{cla_num}
</select>

<!-- 과정 업데이트 -->
<update id="classUpdate" parameterType="java.util.Map">
UPDATE CLASS SET CLA_TITLE = #{cla_title},
				 CLA_CONTENT = #{cla_content},
				 CLA_MAXPEO = #{cla_maxpeo},
				 CLA_PRICE = #{cla_price},
				 CLA_DAILYTIME = #{cla_dailytime},
				 CLA_STARTDATE = #{cla_startdate},
				 CLA_ENDDATE = (SELECT CLA_STARTDATE + (CEIL (CLA_TOTALTIME/CLA_DAILYTIME))+ #{cla_addtime} 
								FROM CLASS c
								WHERE CLA_NUM = #{cla_num}),
				 CLA_STATUS = '준비중'
			 WHERE CLA_NUM = #{cla_num}
</update>


<!-- 임시 과목 선택 리스트 -->
<select id="subjectSelected" resultType="SubjectVo">
SELECT SUB_NUM, SUB_TITLE  
	FROM SUBJECT
</select>

<update id="classTimeUpdate">
UPDATE CLASS SET CLA_TOTALTIME = (SELECT SUM(CUR_TIME)
	FROM SUB_CURRICULUM, CLASS_SUBJECT 
	WHERE CUR_SUB_NUM = CSU_SUB_NUM AND CSU_CLA_NUM = (SELECT MAX(CLA_NUM)FROM CLASS c))
			WHERE CLA_NUM = (SELECT MAX(CLA_NUM)FROM CLASS)
</update>

<!-- ■■■ 투표 ■■■ -->
<!-- 등록된 과정에 학생이 투표 -->
<update id="insApply" parameterType="VoteVo">
UPDATE VOTE 
	SET VOT_INS_ID = #{vot_ins_id}
	WHERE VOT_CLA_NUM =#{vot_cla_num} AND VOT_SUB_NUM = #{vot_sub_num}
</update>

<!-- ■■■ 과정 자료 게시판 Statement ■■■ -->
<!-- 과정 자료 게시판 전체 조회(카테고리별, 해당 과정 번호별) -->
<select id="classBoardSelectedAll" resultType="ClassBoardVo" parameterType="ClassBoardVo">
SELECT CBO_SEQ , CBO_CLA_NUM , CBO_INS_ID , CBO_TITLE ,CBO_REGDATE ,CBO_CATE
	FROM CLASS_BOARD
	WHERE CBO_CATE = #{cbo_cate} AND CBO_CLA_NUM = #{cbo_cla_num}
	ORDER BY CBO_SEQ 
</select>

<!-- 과정 자료 게시판 상세 조회 -->
<select id="classBoardSelectDetail" resultType="ClassBoardVo" parameterType="java.lang.Integer">
SELECT CBO_SEQ, CBO_DOC_SEQ, CBO_CLA_NUM, CBO_CATE, CBO_INS_ID, CBO_TITLE, CBO_CONTENT, CBO_REGDATE, CBO_YOUTUBEADD
	FROM CLASS_BOARD
	WHERE CBO_SEQ = #{cbo_seq}
</select>

<select id="findFile" resultType="java.lang.String" parameterType="java.lang.Integer">
SELECT DOC_ORIGINNAME
	FROM DOCUMENT , CLASS_BOARD
	WHERE DOC_SEQ = CBO_DOC_SEQ
	AND CBO_SEQ = #{cbo_seq}
</select>

<!-- 과정 자료 게시판 글 작성 -->
<insert id="classVideoInsert" parameterType="java.util.Map">
INSERT INTO CLASS_BOARD (CBO_SEQ, CBO_CLA_NUM, CBO_CATE,
						 CBO_INS_ID, CBO_TITLE, CBO_CONTENT, 
						 CBO_REGDATE, CBO_YOUTUBEADD)
				 VALUES (CLASS_BOARD_SEQ.NEXTVAL, #{cbo_cla_num},
				 		#{cbo_cate},
						 #{cbo_ins_id}, #{cbo_title}, #{cbo_content},
						 TO_CHAR(SYSDATE,'YYYY-MM-dd'), #{cbo_youtubeadd})
</insert>

<insert id="classDocInsert" parameterType="java.util.Map">
INSERT INTO DOCUMENT (DOC_SEQ, DOC_FILE, DOC_ORIGINNAME, 
					  DOC_SAVENAME, DOC_PATH, DOC_EXTENTION)
			   VALUES(DOCUMENT_SEQ.NEXTVAL, TO_CHAR(SYSDATE,'YYYY-MM-dd')||'PdfFile', #{doc_originname}, 
			  		  #{doc_savename} ,#{doc_path}, #{doc_extention})
</insert>

<insert id="classBoardDocInsert" parameterType="java.util.Map">
INSERT INTO CLASS_BOARD (CBO_SEQ, CBO_CLA_NUM, CBO_CATE,
						 CBO_INS_ID, CBO_TITLE, CBO_CONTENT, 
						 CBO_REGDATE, CBO_DOC_SEQ)
				 VALUES (CLASS_BOARD_SEQ.NEXTVAL, #{cbo_cla_num}, #{cbo_cate},
						 #{cbo_ins_id}, #{cbo_title}, #{cbo_content},
						 SYSDATE, (SELECT MAX(DOC_SEQ)FROM DOCUMENT))
</insert>



<!-- 쪽지 게시판 -->
<!-- 쪽지 게시판 전체조회 -->
<select id="messendBoardSelectAll" resultType="MessageBoardVo" parameterType="MessageBoardVo">
SELECT MES_SEQ , MES_SENDER , MES_RECIPIENT , CASE WHEN LENGTH(MES_CONTENT) > 15 THEN SUBSTR(MES_CONTENT,0,15) || '...' ELSE MES_CONTENT END MES_CONTENT ,  MES_CATE , MES_REFFER , MES_REGDATE 
	FROM MESSAGE_BOARD
	<if test="mes_cate == 'Q'.toString() or  mes_cate =='null'">
	WHERE MES_CATE = #{mes_cate} AND MES_SENDER = #{mes_sender}
	</if>
	<if test="mes_cate == 'R'.toString()">
	WHERE MES_CATE = #{mes_cate} AND MES_RECIPIENT = #{mes_recipient}
	</if>
	ORDER BY MES_REFFER
</select>

<select id="mesBoardSelectDetail" resultType="MessageBoardVo" parameterType="java.lang.Integer">
SELECT MES_SEQ , MES_SENDER , MES_RECIPIENT, MES_CONTENT , MES_REGDATE 
	FROM MESSAGE_BOARD mb 
	WHERE MES_SEQ = #{mes_seq}
</select>



</mapper>
